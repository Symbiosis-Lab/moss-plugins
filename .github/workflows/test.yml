name: Test

on:
  push:
    branches: [main]
  pull_request:

jobs:
  # Detect which plugins changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      js_plugins: ${{ steps.changes.outputs.js_plugins }}
      js_plugins_csv: ${{ steps.changes.outputs.js_plugins_csv }}
      has_hugo: ${{ steps.changes.outputs.has_hugo }}
      rust_plugins: ${{ steps.changes.outputs.rust_plugins }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed plugins
        id: changes
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1)
          fi

          # Find JavaScript plugins at root level (have package.json)
          JS_PLUGINS="[]"
          JS_PLUGINS_CSV=""
          HAS_HUGO="false"
          for dir in */; do
            plugin_name=$(basename "$dir")
            # Skip hidden directories and .github
            if [[ "$plugin_name" == .* ]] || [[ "$plugin_name" == ".github" ]]; then
              continue
            fi
            if [ -f "${dir}package.json" ]; then
              if echo "$CHANGED_FILES" | grep -q "^$plugin_name/"; then
                JS_PLUGINS=$(echo "$JS_PLUGINS" | jq -c ". + [\"$plugin_name\"]")
                if [ -n "$JS_PLUGINS_CSV" ]; then
                  JS_PLUGINS_CSV="$JS_PLUGINS_CSV,$plugin_name"
                else
                  JS_PLUGINS_CSV="$plugin_name"
                fi
                if [ "$plugin_name" == "hugo" ]; then
                  HAS_HUGO="true"
                fi
              fi
            fi
          done

          # Find Rust plugins at root level (have Cargo.toml)
          RUST_PLUGINS="[]"
          for dir in */; do
            plugin_name=$(basename "$dir")
            # Skip hidden directories and .github
            if [[ "$plugin_name" == .* ]] || [[ "$plugin_name" == ".github" ]]; then
              continue
            fi
            if [ -f "${dir}Cargo.toml" ]; then
              if echo "$CHANGED_FILES" | grep -q "^$plugin_name/"; then
                RUST_PLUGINS=$(echo "$RUST_PLUGINS" | jq -c ". + [\"$plugin_name\"]")
              fi
            fi
          done

          echo "js_plugins=$JS_PLUGINS" >> $GITHUB_OUTPUT
          echo "js_plugins_csv=$JS_PLUGINS_CSV" >> $GITHUB_OUTPUT
          echo "has_hugo=$HAS_HUGO" >> $GITHUB_OUTPUT
          echo "rust_plugins=$RUST_PLUGINS" >> $GITHUB_OUTPUT
          echo "Changed JS plugins: $JS_PLUGINS"
          echo "Changed JS plugins (CSV): $JS_PLUGINS_CSV"
          echo "Has Hugo: $HAS_HUGO"
          echo "Changed Rust plugins: $RUST_PLUGINS"

  # Test all JavaScript plugins in a single job
  test-plugins:
    needs: detect-changes
    if: needs.detect-changes.outputs.js_plugins != '[]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev xvfb

      - name: Download moss binary for e2e tests
        run: |
          # Download latest moss release (v0.3.1+ required for --wait-plugins)
          gh release download --repo Symbiosis-Lab/moss -p 'moss-linux-x64' -O moss-linux-x64 || {
            echo "Warning: Could not download moss binary. E2E tests will be skipped."
            exit 0
          }
          chmod +x moss-linux-x64
          echo "MOSS_BINARY=$(pwd)/moss-linux-x64" >> $GITHUB_ENV
          # Verify binary works
          ./moss-linux-x64 --help | head -5
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Install Hugo (if hugo plugin changed)
        if: needs.detect-changes.outputs.has_hugo == 'true'
        run: |
          wget -q https://github.com/gohugoio/hugo/releases/download/v0.139.0/hugo_extended_0.139.0_linux-amd64.deb
          sudo dpkg -i hugo_extended_0.139.0_linux-amd64.deb
          hugo version

      - name: Test all changed plugins
        run: |
          PLUGINS="${{ needs.detect-changes.outputs.js_plugins_csv }}"
          IFS=',' read -ra PLUGIN_ARRAY <<< "$PLUGINS"

          for plugin in "${PLUGIN_ARRAY[@]}"; do
            echo "=========================================="
            echo "Testing plugin: $plugin"
            echo "=========================================="

            cd "$plugin"

            echo "Installing dependencies..."
            npm ci

            echo "Type checking..."
            npx tsc --noEmit

            echo "Building..."
            npm run build

            echo "Running tests with coverage..."
            xvfb-run --auto-servernum npm run test:coverage || true

            cd ..
          done

      - name: Run Hugo E2E tests (if hugo changed)
        if: needs.detect-changes.outputs.has_hugo == 'true'
        run: |
          cd hugo
          npm run test:e2e

      - name: Run binary resolver download tests (if hugo changed)
        if: needs.detect-changes.outputs.has_hugo == 'true'
        run: |
          cd hugo
          npm run test:e2e -- --testNamePattern="Full Download Flow|GitHub API"
        env:
          TEST_DOWNLOAD_HUGO: 'true'
          GITHUB_TOKEN: ${{ github.token }}

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: "*/coverage/lcov.info"
          token: ${{ secrets.CODECOV_TOKEN }}

  # Test Rust plugins
  test-rust:
    needs: detect-changes
    if: needs.detect-changes.outputs.rust_plugins != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        plugin: ${{ fromJson(needs.detect-changes.outputs.rust_plugins) }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Run tests with coverage
        run: |
          cd ${{ matrix.plugin }}
          cargo llvm-cov --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ${{ matrix.plugin }}/lcov.info
          flags: ${{ matrix.plugin }}
          name: ${{ matrix.plugin }}-rust
          token: ${{ secrets.CODECOV_TOKEN }}

  # macOS E2E tests for all JS plugins (no xvfb needed)
  test-macos-e2e:
    needs: detect-changes
    if: needs.detect-changes.outputs.js_plugins != '[]'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download moss binary for e2e tests
        run: |
          # Download latest moss release (v0.3.1+ required for --wait-plugins)
          gh release download --repo Symbiosis-Lab/moss -p 'moss-darwin-universal' -O moss-darwin-universal || {
            echo "Warning: Could not download moss binary. E2E tests will be skipped."
            exit 0
          }
          chmod +x moss-darwin-universal
          echo "MOSS_BINARY=$(pwd)/moss-darwin-universal" >> $GITHUB_ENV
          # Verify binary works
          ./moss-darwin-universal --help | head -5
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Test all changed plugins (e2e only)
        run: |
          PLUGINS="${{ needs.detect-changes.outputs.js_plugins_csv }}"
          IFS=',' read -ra PLUGIN_ARRAY <<< "$PLUGINS"

          for plugin in "${PLUGIN_ARRAY[@]}"; do
            echo "=========================================="
            echo "Testing plugin (macOS e2e): $plugin"
            echo "=========================================="

            cd "$plugin"

            echo "Installing dependencies..."
            npm ci

            echo "Building..."
            npm run build

            echo "Running e2e tests..."
            npm run test:e2e || true

            cd ..
          done

  # Cross-platform tests for Hugo (macOS and Windows only, Ubuntu covered above)
  test-cross-platform:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_hugo == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Hugo (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install hugo
          hugo version

      - name: Install Hugo (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install hugo-extended -y
          hugo version

      - name: Install dependencies
        run: |
          cd hugo
          npm ci

      - name: Run E2E tests
        run: |
          cd hugo
          npm run test:e2e

      - name: Run binary resolver download tests
        run: |
          cd hugo
          npm run test:e2e -- --testNamePattern="Full Download Flow|GitHub API"
        env:
          TEST_DOWNLOAD_HUGO: 'true'
          GITHUB_TOKEN: ${{ github.token }}

  # Summary job for branch protection
  test-summary:
    needs: [test-plugins, test-rust, test-cross-platform, test-macos-e2e]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-plugins.result }}" == "failure" ] || \
             [ "${{ needs.test-rust.result }}" == "failure" ] || \
             [ "${{ needs.test-cross-platform.result }}" == "failure" ] || \
             [ "${{ needs.test-macos-e2e.result }}" == "failure" ]; then
            echo "Some tests failed"
            exit 1
          fi
          echo "All tests passed (or skipped)"
